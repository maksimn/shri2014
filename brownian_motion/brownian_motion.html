<!DOCTYPE html>
<head>
    <title>Brownian motion</title>
    <meta charset="utf-8">
    <style>
        body {
            background: #000;
        }

        h1 {
            color: brown;
        }

        circle {
            fill: #f00;
        }

        svg {
            border: 3px solid #fff;
            padding: 6px;
        }
    </style>
</head>
<body>
    <h1>Brownian Motion Demo</h1>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
        var width = 960, height = 500;

        var n = 100, m = 12, degrees = 180 / Math.PI;

        var particles = d3.range(n).map(function () {
            var x = Math.random() * width,
                y = Math.random() * height;
            return {
                vx: Math.random() * 2 - 1,
                vy: Math.random() * 2 - 1,
                path: d3.range(m).map(function () { return [x, y]; }),
                count: 0
            };
        });

        var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);

        var g = svg.selectAll("g").data(particles).enter().append("g");

        var circles = g.append("circle").attr("r", 6.0);

        d3.timer(function () {
            for (var i = 0; i < n; i++) {
                var particle = particles[i],
                    path = particle.path,
                    dx = particle.vx,
                    dy = particle.vy,
                    x = path[0][0] += dx,
                    y = path[0][1] += dy,
                    speed = Math.sqrt(dx * dx + dy * dy),
                    count = speed * 10,
                    k1 = -5 - speed / 3;

                // Bounce off the walls.
                if (x < 0 || x > width) particle.vx *= -1;
                if (y < 0 || y > height) particle.vy *= -1;

                // Swim!
                for (var j = 1; j < m; j++) {
                    var vx = x - path[j][0],
                        vy = y - path[j][1],
                        k2 = Math.sin(((particle.count += count) + j * 3) / 300) / speed;
                    path[j][0] = (x += dx / speed * k1) - dy * k2;
                    path[j][1] = (y += dy / speed * k1) + dx * k2;
                    speed = Math.sqrt((dx = vx) * dx + (dy = vy) * dy);
                }
            }

            circles.attr("transform", circleTransform);
        });

        function circleTransform(d) {
            return "translate(" + d.path[0] + ")rotate(" + Math.atan2(d.vy, d.vx) * degrees + ")";
        }
    </script>
</body>